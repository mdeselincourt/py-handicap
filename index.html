<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Handicap Inspector</title>

  <meta property="og:title" content="Handicap Inspector">
  <meta property="og:type" content="website">
  <meta property="og:description" content="A simple HTML5 Template for new projects.">
  <meta property="og:image" content="image.png">

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <link rel="stylesheet" href="css/styles.css?v=1.0">

  	<style>
		
		body {
			font-family: 'Montserrat', Arial, Helvetica, sans-serif;
		}
		h1, h2  {color: blue;}	

	</style>

</head>

<body>

<h1>Handicap Inspector</h1>

    <form>
        <select id="aBoat">
            <option value="Laser">Laser</option>
        </select>
        <input type="text" id="aPY" value="1078"/>
        <select id="bBoat">
            <option value="Solo">Solo</option>
        </select>
        <input type="text" id="bPY" value="1148"/>
    </form>

    <button onClick="calculate()">Calculate</button>

    </body>

    <script>

        function calculate() {

            var results = [
                ["1", "D", "Laser", "8693", "1078", "MS"],
                ["1", "D", "Laser", "8836", "1078", "KA"],
                ["1", "D", "Laser", "9436", "1078", "EH"],
                ["1", "D", "Laser", "8243", "1078", "JG"],
                ["1", "D", "Laser", "8853", "1078", "AW"],
                ["1", "D", "Laser", "8364", "1078", "HC"],
                ["1", "D", "Laser", "9325", "1078", "PH"],
                ["1", "D", "Laser", "9138", "1078", "HB"],
                ["1", "D", "Laser", "8820", "1078", "AM"],
                ["1", "D", "Solo", "9574", "1148", "PM"],
                ["1", "D", "Solo", "8467", "1148", "SB"],
                ["1", "D", "Solo", "8518", "1148", "JC"],
                ["1", "D", "Solo", "8274", "1148", "AMF"],
                ["2", "L", "Enterprise", "4074", "1111", "JD"],
                ["2", "L", "GP14", "3944", "1129", "FS"],
                ["2", "L", "Laser", "3319", "1078", "JG"],
                ["2", "L", "Laser", "3385", "1078", "EH"],
                ["2", "L", "Laser", "3503", "1078", "RH"],
                ["2", "L", "Laser", "3691", "1078", "SG"],
                ["2", "L", "Laser", "4319", "1078", "PH"],
                ["2", "L", "Solo", "3472", "1148", "AMF"],
                ["2", "L", "Solo", "3684", "1148", "PM"],
                ["2", "L", "Solo", "3810", "1148", "SB"],
                ["2", "L", "Solo", "4072", "1148", "AW"],
                ["4", "L", "Laser4.7", "4072", "1174", "EA"],
                ["4", "L", "Laser4.7", "3442", "1174", "PH"],
                ["4", "L", "LaserRadial", "3180", "1111", "JC"],
                ["4", "L", "LaserRadial", "3311", "1111", "HC"],
                ["4", "L", "LaserRadial", "3286", "1111", "DB"],
                ["4", "L", "LaserRadial", "3684", "1111", "JG"],
                ["4", "L", "Solo", "3255", "1148", "PM"],
                ["4", "L", "Solo", "3364", "1148", "AMF"],
                ["5", "D", "Laser", "7116", "1078", "RH"],
                ["5", "D", "Laser", "7463", "1078", "EH"],
                ["5", "D", "Solo", "7242", "1148", "JC"],
                ["5", "D", "Solo", "7256", "1148", "AMF"],
                ["5", "D", "Solo", "7450", "1148", "SB"],
                ["7", "D", "Laser", "8700", "1078", "RH"],
                ["7", "D", "Laser", "8224", "1078", "PM"],
                ["7", "D", "Laser", "8440", "1078", "JG"],
                ["7", "D", "Laser", "8244", "1078", "EH"],
                ["7", "D", "Solo", "8686", "1148", "SB"],
                ["7", "D", "Solo", "8657", "1148", "SG"],
                ["7", "D", "Solo", "8074", "1148", "AMF"],
                ["8", "L", "Laser", "2982", "1078", "JG"],
                ["8", "L", "Laser4.7", "4068", "1174", "HB"],
                ["8", "L", "Solo", "3373", "1148", "SG"],
                ["8", "L", "Solo", "3213", "1148", "JC"],
                ["8", "L", "Solo", "3574", "1148", "AMF"],
                ["9", "L", "Laser", "2874", "1078", "RH"],
                ["9", "L", "Solo", "2936", "1148", "JC"],
                ["10", "L", "Laser", "3919", "1078", "JL"],
                ["10", "L", "Laser", "4790", "1078", "EA"],
                ["10", "L", "Solo", "3881", "1148", "AMF"],
                ["11", "L", "LaserRadial", "4260", "1111", "RH"],
                ["11", "L", "LaserRadial", "4346", "1111", "JC"]
            ]

            var columns = {
                "race": 0,
                "raceType": 1,
                "boatClass": 2,
                "elapsed": 3,
                "officialPy": 4,
                "helm": 5,
                "corrected": 6
            }

            console.log("Structuring data (inefficiently)...")

            var races = [
                [],[],[],[],[],[],[],[],[],[],[],[]
            ]

            results.forEach(seperateRaces)

            function seperateRaces(row) {
                race = parseInt(row[columns.race])

                if(!races[race]) {
                    races[race] = []
                }

                //console.log("Adding a result to race " + race)
                races[race].push(row)
            }

            //console.log("Races are:")
            //console.log(races)

            // set defaults
            var PYs = {
                "Laser": 1078,
                "LaserRadial": 1111,
                "Laser4.7": 1174,
                "Solo": 1148,
                "Enterprise": 1111,
                "GP14": 1129,
                "Xenon": 1080
            }

            console.log("Reading form and editing PYs...")

            PYs[document.getElementById("aBoat").value] = parseInt(document.getElementById("aPY").value)
            PYs[document.getElementById("bBoat").value] = parseInt(document.getElementById("bPY").value)

            console.log(PYs)

            console.log("Applying handicaps...")

            races.forEach(handicapRace)

            function handicapRace(race) {
                race.forEach(correctTime)
            }

            function correctTime(row) {

                if(PYs[row[columns.boatClass]]) {
                    //console.log("Correcting time for " + row[columns.helm] + " in race " + row[columns.race])
                    //console.log("elapsed is " + row[columns.elapsed])
                    //console.log("PY is " + PYs[row[columns.boatClass]])
                    row.push(row[columns.elapsed] * 1000 / PYs[row[columns.boatClass]])
                }
                
            }

            console.log("Sorting by corrected times")

            // Is there a more elegant expression to do this?
            races.forEach(sortRace)

            function sortRace(race) {
                //console.log("Sorting a race...")
                race.sort(function(a,b) {
                    return a[columns.corrected] - b[columns.corrected];
                })
            }

            console.log(races)

            console.log("Analysing new results...")

            var wins = {}

            races.forEach(countWins)

            function countWins(race) {
                
                
                if(race[0]) { // Skip empty races!
                    
                    // Credit the win                    
                    firstPlace = race[0]
                    boatClass = firstPlace[columns.boatClass]
                    if(!wins[boatClass]) 
                        { wins[boatClass] = 1 } 
                    else 
                        { wins[boatClass] = wins[boatClass] + 1}

                    
                    
                }
            }

            console.log(wins)

        }

    </script>
	
</body>
</html>